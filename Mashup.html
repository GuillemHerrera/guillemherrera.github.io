
<html lang="es">
   <head>
     <title>Leaflet y Mapox</title>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta name="author" content="autor" />
     <meta name="description" content="descripción página">
     <meta name="robots" content="index,follow">
     <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
     <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />

     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
     <script type="text/javascript" src="js/skycons.js"></script>

     <style>
       body {
         margin: 0;
         padding: 0;
         overflow: hidden;
       }
       #map {
         height: 100%;
         width: 100%;
       }
       div.mapboxgl-popup-content {text-align: center;}
     </style>
     <script type="text/javascript">
      var map;
      var boundStationsArray = [];
      var geojson = {
                  type: "FeatureCollection",
                  features: [],
                  };
       $(document).ready(function () {
       mapboxgl.accessToken = 'pk.eyJ1IjoiZ3VpbGxlbWhlcnJlcmEiLCJhIjoiY2pjamdtMjMyMjU3OTJ3cGEzOHk0eGt3MCJ9.37rBv4h8G6B33tiBCDhsow';
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/guillemherrera/cjdmb3def1gr92sp9g2j6qen1',
                center: [2.16859, 41.3954],
                zoom: 12,
                minzoom: 3,
                maxzoom: 10,
                hash: true,
                //pitch: 45
                });
             map.on('load', function () {
                  map.addSource("windLayer", {
                      type: "raster",
                      tiles: ["https://tile.openweathermap.org/map/wind/{z}/{x}/{y}.png?appid=5e92732603fbd313828ea9351de0c78c"],
                  });  //fin map source
                  map.addLayer({
                      'id': 'wind',
                      'type': 'raster',
                      'source': 'windLayer',
                      'minzoom': 0,
                      'maxzoom': 20,
                      'paint': {'raster-opacity': 0.3}
                      })
                });
            
              function stationscall() {
                var bounds  = map.getBounds(); 
                var stationscall = 'https://secure.geonames.org/weatherJSON?' +
                    'north=' + bounds.getNorth() + '&' +
                    'south=' + bounds.getSouth() + '&' +
                    'east=' + bounds.getEast() + '&' +
                    'west=' + bounds.getWest() + '&' +
                    'maxRows=1000&' + 
                    'username=guillemherrera';
                    //alert(stationscall);

                    $.ajax({
                    url: stationscall,
                    method: "GET",
                    dataType: "json",
                    success: function (response) {
                        
                        boundStationsArray = response.weatherObservations;
                        makeGeoJson(boundStationsArray);
                        console.info(geojson);
                        //alert(stationscall);  
                    },
                    complete: displayGeoJsonPoints()
                });//fin ajax
              }
              
              function  makeGeoJson (stationslist) {

                  geojson = {
                  type: "FeatureCollection",
                  features: [],
                  };
                  for (i = 0; i < stationslist.length; i++) {
                    geojson.features.push({
                      "type": "Feature",
                      "geometry": {
                          "type": "Point",
                          "coordinates": [stationslist[i].lng, stationslist[i].lat]
                                  },
                        "properties": {
                          "id": stationslist[i].ICAO,
                          //"clouds": stationslist[i].clouds,
                          //"datetime": stationslist[i].datetime,
                          //"station": stationslist[i].stationName,
                          //"temperature": stationslist[i].temperature,
                          "windDirection": stationslist[i].windDirection,
                          "windSpeed": Number(stationslist[i].windSpeed),
                          //"humidity": stationslist[i].humidity,
                          //"pressure": stationslist[i].hectoPascAltimeter
                        }
                    });
                  }
              }

              function displayGeoJsonPoints () {
                        
                        map.on('load', function () {

                          map.addSource("geojsonStations", {
                              "type": "geojson",
                              "data": geojson
                              
                          });

                          map.addLayer({
                              id: "stations",
                              interactive: "true",
                              type: "symbol",
                              source: 'geojsonStations',
                              "layout": {
                                  "icon-image": "drawing",
                                  "icon-allow-overlap": {
                                          stops : [[0,false], [4, true]]
                                         },
                                  "icon-size": {
                                        property: 'windSpeed',
                                        type: 'exponential',
                                        stops: [
                                          [0, 0],
                                          [10, 1],
                                          [30,2],
                                          [60, 3]
                                        ],
                                        default: 0.2
                                        },
                                  "icon-rotate":{
                                        type: 'identity',
                                        property: 'windDirection'
                                        },
                                  "icon-padding": 1

                                       }
                          });
                        });

                        
                        /*
                        map.on('resize',function(){

                          stationscall();
                          displayGeoJsonPoints();
                          //map.getSource('geojsonStations').setData(geojson);
                        });
                       */
              }
              /*
              function displayStations(sinfo) {
                for (var i = 0; i < sinfo.length; i++) {
                  var station = sinfo[i];
                  console.info(station);
                  var marker = new mapboxgl.Marker()
                  .setLngLat([station.lng, station.lat])
                  .addTo(map);
                };
              }
*/
              stationscall();
              window.setInterval(function() {
                              map.getSource('geojsonStations').setData(geojson);
                          }, 1000);
              map.on('zoomend', function () {
                stationscall();
                window.setInterval(function() {
                  map.getSource('geojsonStations').setData(geojson);
              }, 1000);
              });

              map.on('dragend', function () {
                stationscall();
                window.setInterval(function() {
                  map.getSource('geojsonStations').setData(geojson);
              }, 1000);
              });

              //displayGeoJsonPoints();
                //map.getSource('geojsonStations').setData(geojson);
             /* 
              map.on('moveend', function () {
                stationscall();
                //displayGeoJsonPoints();
                //map.getSource('geojsonStations').setData(geojson);

              });
                     */     
              /* map.on('click', function (e) {

                    popup.setLngLat(e.features[0].geometry.coordinates)
                    .setHTML(e.features[0].properties.windSpeed)
                    .addTo(map);
               });
                */
                
                var popup2 = new mapboxgl.Popup()
                map.on('mouseenter', 'stations', function (e) {
                  map.getCanvas().style.cursor = 'pointer';
                  popup2.setLngLat(e.features[0].geometry.coordinates)
                              .setHTML(e.features[0].properties.windSpeed)
                              .addTo(map);
                });
                
                map.on('mouseleave', 'stations', function () {
                    map.getCanvas().style.cursor = '';
                    window.setInterval(function() {
                              popup2.remove();
                          }, 3000);
                });
              
             /*
                    $.ajax({
                    url: stationscall,
                    method: "GET",
                    dataType: "json",
                    success: function (response) {
                        
                        boundStationsArray = response.weatherObservations;
                        makeGeoJson(boundStationsArray);
                        console.info(geojson);
                        //alert(stationscall);  
                    },
                    complete: displayGeoJsonPoints()
                });//fin ajax
              }
*/
              map.on('click', function (a) {
                    var lng = a.lngLat.lng;
                    var lat = a.lngLat.lat;
                    console.info(lat);
                    var preproxy = 'https://thingproxy.freeboard.io/fetch/'
                    var positioncall = preproxy +'https://thingproxy.freeboard.io/fetch/https://api.darksky.net/forecast/66b4870d52e4f5c95469bdc50d6c422f/' +
                    lat+','+lng+'?exclude=hourly,daily,flags&units=si&lang=es'; 
                    console.info(positioncall);
                    $.ajax({
                    url: positioncall,
                    method: "GET",
                    dataType: "json",
                    success: function (response) {
                                makeMarker(response);                     
                    },
                });//fin ajax//alert(lng);

                 });
              function makeMarker(minfo){
                var popup = new mapboxgl.Popup()
                  .setLngLat([minfo.longitude, minfo.latitude])
                  .setHTML ('<p>'+minfo.currently.summary +'</p><canvas id="'+minfo.currently.icon+'" width="64" height="64">'+
                  '</canvas></br>')
                  .addTo(map);
                  var skycons = new Skycons({"color": "black"});
                  skycons.add(minfo.currently.icon, minfo.currently.icon);
                  skycons.play();
              }
              });
     </script>
   </head>
   <body>
     <div id="map"></div>
    
    </body>
   </html>
